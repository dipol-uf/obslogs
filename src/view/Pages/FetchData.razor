@page "/fetchdata"
@using System.Text.Json.Serialization
@using System.Globalization
@inject HttpClient _http

<h1>Dipol observations</h1>

<p>A log of DIPol-2 and DIPol-UF observations.</p>
<p>
    <div class="input-group mb-4 w-75">
        <input
            type="text"
            value="@Value"
            @onkeydown="SearchField_OnKeyDown"
            @oninput="SearchField_OnInput"
            class="form-control mr-2"/>
        <div class="input-group-append">
            <button class="btn btn-primary" @onclick="FilterData" type="submit">Search</button>
        </div>
    </div>
</p>

@*First time loading, no data is yet available*@
@if (_observations.Length == 0)
{
    <p><em>Loading...</em></p>
}
@*The table is empty -> no entries match search criteria*@
else if (Items.TryGetNonEnumeratedCount(out var count) && count == 0 || !Items.Any())
{
    <p><em>No observation satisfies given criteria.</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Object</th>
                <th>Exposure (s)</th>
                <th>Images</th>
                <th>Instrument</th>
                <th>Telescope</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var obs in Items)
            {
            <tr>
                <td>@obs.Date.ToString("yyyy/MM/dd", DateTimeFormatInfo.InvariantInfo)</td>
                <td>@obs.Object</td>
                <td>@(obs.ExpTime?.ToString("F1") ?? "??")</td>
                <td>@(@obs.N.ToString() ?? "??")</td>
                <td>@obs.Instrument</td>
                <td>@obs.Telescope</td>
            </tr>
            }
        </tbody>
    </table>
}

@code {
    private DipolObservation[] _observations = Array.Empty<DipolObservation>();
    private bool _shouldRender = true;
    private string Value { get; set; } = string.Empty;

    private IEnumerable<DipolObservation> Items { get; set; } = Enumerable.Empty<DipolObservation>();

    private void FilterData()
    {
        var val = Value;
        IEnumerable<DipolObservation> newObservations = string.IsNullOrWhiteSpace(val)
            ? _observations 
            : _observations.Where(Filter);

        if (ReferenceEquals(newObservations, Items))
        {
            return;
        }

        Items = newObservations;
       
        _shouldRender = true;
     
        bool Filter(DipolObservation obs) => obs.Object.AsSpan().Contains(val, StringComparison.OrdinalIgnoreCase);
    }

    protected override async Task OnInitializedAsync()
    {
        _observations = await _http.GetFromJsonAsync<DipolObservation[]>("sample-data/obslog.json")
                        ?? throw new InvalidOperationException("Failed to load data");

        Items = _observations;
    }

    protected override bool ShouldRender()
    {
        if (_shouldRender)
        {
            _shouldRender = false;
            return true;
        }
        return false;
    }


    private void SearchField_OnKeyDown(KeyboardEventArgs obj)
    {
        if (obj.Code == "Enter")
        {
            FilterData();
        }
    }

    private void SearchField_OnInput(ChangeEventArgs obj)
    {
        if (obj.Value is string newString)
        {
            Value = newString;
            if (string.IsNullOrWhiteSpace(newString))
            {
                FilterData();
            }
            else
            {
                _shouldRender = false;
            }
        }
    }

    internal record DipolObservation(
        [property:JsonPropertyName("Date")] string DateStr,
        string Object,
        string? Type,
        double? ExpTime,
        int? N,
        double? Focus,
        [property:JsonPropertyName("Inst")] string Instrument,
        [property:JsonPropertyName("Tlscp")] string Telescope,
        string? Comment
    )
    {
        [JsonIgnore]
        public DateTimeOffset Date => DateTimeOffset.TryParseExact(
            DateStr,
            "yyyy-MM-dd",
            DateTimeFormatInfo.InvariantInfo,
            DateTimeStyles.AssumeUniversal,
            out var date
        ) ? date : default;
    }


}
